<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, user-scalable=no">
<style type="text/css">
body { margin: 0px; overflow: hidden; }
canvas { border: 1px solid black; }
</style>
<title>controller</title>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">
	$(document).ready(function () {
		locOrientation = screen.lockOrientation || screen.mozLockOrientation || screen.msLockOrientation || screen.orientation?.lock;
		if(locOrientation){
			locOrientation('landscape');
		}
		else{
			window.orientation.toFixed(90)}
        });
</script>
<script type="text/javascript" src="/static/magictouch.js"></script>
<script type="text/javascript">

var canvas;
var ctx;
var w = 0;
var h = 0;

const holder = 2;
const analog = 1;
const defauld = 0;

let figures = [];

var timer;
var updateStarted = false;
var touches = [];
var previusSelected = [];
var previusActionObject = {};


function update() {
	if (updateStarted) return;
	updateStarted = true;

	var nw = window.innerWidth;
	var nh = window.innerHeight;

	if ((w != nw) || (h != nh)) {
		w = nw;
		h = nh;
		canvas.style.width = w+'px';
		canvas.style.height = h+'px';
		canvas.width = w;
		canvas.height = h;
	}
	let selected = [];
	let actionObject = {};
	figures.forEach(figure => {
		figure.selected = false;
		if(touches && touches.length>0) {
			let i, len = touches.length;
			for (i=0; i<len; i++) {
				var touch = touches[i];
				let distance = Math.sqrt(Math.pow(touch.pageX - figure.center.w, 2) + Math.pow(touch.pageY - figure.center.h, 2));
				if(distance < figure.radius+20){
					figure.selected = true;
					selected.push(figure.text);
					actionObject[figure.text]={
						figure: figure,
						touch: touch
					};
				}
			}
		}
	});
	let unselected = [];

	previusSelected.forEach(ps=>{
		if(selected.filter(s=>s==ps).length==0){
			unselected.push(ps);
			actionObject[ps]=previusActionObject[ps];
		}
	});
	clear();
	/*var i, len = touches.length;
	for (i=0; i<len; i++) {
		var touch = touches[i];
    	var px = touch.pageX;
    	var py = touch.pageY;

		ctx.beginPath();
		ctx.arc(px, py, 20, 0, 2*Math.PI, true);

		ctx.fillStyle = "rgba(0, 0, 200, 0.2)";
		ctx.fill();

		ctx.lineWidth = 2.0;
		ctx.strokeStyle = "rgba(0, 0, 200, 0.8)";
		ctx.stroke();
    	console.log('drawn circle at ' + px +',' + py);
	}*/
	// TODO: after promises
	if(selected.length>0 || unselected.length>0) {
	console.log(selected);
	console.log(unselected);
	}
	previusSelected = selected;
	previusActionObject = actionObject;
	updateStarted = false;
}

function ol() {
	canvas = document.getElementById('canvas');
	ctx = canvas.getContext('2d');
	timer = setInterval(update, 15);

	canvas.addEventListener('touchend', function() {
		clear();
	});

	canvas.addEventListener('touchmove', function(event) {
	event.preventDefault();
	touches = event.touches;
	});

	canvas.addEventListener('touchstart', function(event) {
	console.log('start');
	});
};

function clear(){
	ctx.clearRect(0, 0, w, h);
	let drawTop = h/8;
	let drawHeight = h-drawTop;
	figures = [{
		center: {
			w: w/16,
			h: drawTop/2
		},
		radius: Math.min(drawTop/2,(w/32)-2),
		text: "HL2",
		actionType: holder,
		action: "L2"
	},{
		center: {
			w: (w/16)*2,
			h: drawTop/2
		},
		radius: Math.min(drawTop/2,(w/32)-2),
		text: "L2",
		actionType: defauld
	},{
		center: {
			w: (w/16)*3,
			h: drawTop/2
		},
		radius: Math.min(drawTop/2,(w/32)-2),
		text: "HL",
		actionType: holder,
		action: "L"
	},{
		center: {
			w: (w/16)*4,
			h: drawTop/2
		},
		radius: Math.min(drawTop/2,(w/32)-2),
		text: "L",
		actionType: defauld
	},{
		center: {
			w: w-((w/16)*4),
			h: drawTop/2
		},
		radius: Math.min(drawTop/2,(w/32)-2),
		text: "R",
		actionType: defauld
	},{
		center: {
			w: w-((w/16)*3),
			h: drawTop/2
		},
		radius: Math.min(drawTop/2,(w/32)-2),
		text: "HR",
		actionType: holder,
		action: "R"
	},{
		center: {
			w: w-((w/16)*2),
			h: drawTop/2
		},
		radius: Math.min(drawTop/2,(w/32)-2),
		text: "R2",
		actionType: defauld
	},{
		center: {
			w: w-((w/16)),
			h: drawTop/2
		},
		radius: Math.min(drawTop/2,(w/32)-2),
		text: "HR2",
		actionType: holder,
		action: "R2"
	},{
		center: {
			w: w/4,
			h: (drawHeight/4)+drawTop
		},
		radius: Math.min(w,drawHeight)/5,
		text: "JL",
		actionType: analog,
		analog: "L"
	},{
		center: {
			w: (w/4)*3,
			h: (drawHeight/4)+drawTop-Math.min(w,drawHeight)/8
		},
		radius: Math.min(w,drawHeight)/12,
		text: "X",
		actionType: defauld
	},{
		center: {
			w: (w/4)*3,
			h: (drawHeight/4)+drawTop+Math.min(w,drawHeight)/8
		},
		radius: Math.min(w,drawHeight)/12,
		text: "B",
		actionType: defauld
	},{
		center: {
			w: ((w/4)*3)-Math.min(w,drawHeight)/8,
			h: (drawHeight/4)+drawTop
		},
		radius: Math.min(w,drawHeight)/12,
		text: "Y",
		actionType: defauld
	},{
		center: {
			w: ((w/4)*3)+Math.min(w,drawHeight)/8,
			h: (drawHeight/4)+drawTop
		},
		radius: Math.min(w,drawHeight)/12,
		text: "A",
		actionType: defauld
	},{
		center: {
			w: w/3,
			h: ((drawHeight/4)*3)+drawTop-Math.min(w,drawHeight)/8
		},
		radius: Math.min(w,drawHeight)/12,
		text: "Up",
		actionType: defauld
	},{
		center: {
			w: w/3,
			h: ((drawHeight/4)*3)+drawTop+Math.min(w,drawHeight)/8
		},
		radius: Math.min(w,drawHeight)/12,
		text: "Down",
		actionType: defauld
	},{
		center: {
			w: (w/3)-Math.min(w,drawHeight)/8,
			h: ((drawHeight/4)*3)+drawTop
		},
		radius: Math.min(w,drawHeight)/12,
		text: "Left",
		actionType: defauld
	},{
		center: {
			w: (w/3)+Math.min(w,drawHeight)/8,
			h: ((drawHeight/4)*3)+drawTop
		},
		radius: Math.min(w,drawHeight)/12,
		text: "Right",
		actionType: defauld
	},{
		center: {
			w: (w/3)*2,
			h: ((drawHeight/4)*3)+drawTop
		},
		radius: Math.min(w,drawHeight)/5,
		text: "JR",
		actionType: analog,
		analog: "R"
	},{
		center: {
			w: w/2.5,
			h: (drawHeight/2.5)+drawTop
		},
		radius: Math.min(w,drawHeight)/12,
		text: "-",
		actionType: defauld
	},{
		center: {
			w: w/2+((w/2)-(w/2.5)),
			h: (drawHeight/2.5)+drawTop
		},
		radius: Math.min(w,drawHeight)/12,
		text: "+",
		actionType: defauld
	},{
		center: {
			w: w/2,
			h: (drawHeight/4)+drawTop
		},
		radius: Math.min(w,drawHeight)/12,
		text: "H",
		actionType: defauld
	}
];

	figures.forEach(fig => {
		ctx.beginPath();
		ctx.arc(fig.center.w, fig.center.h, fig.radius, 0, 2 * Math.PI, true);
		if(fig.selected){
			ctx.fillStyle = "rgba(0, 0, 200, 0.2)";
			ctx.fill();
		}
		ctx.stroke();
		ctx.font = "30px Comic Sans MS";
		ctx.textAlign = "center";
		ctx.fillText(fig.text, fig.center.w, fig.center.h);
	});
}

</script>
</head>
<body onload="ol()">
	
<canvas id="canvas" width="300" height="300" style="top:0px; left:0px; width: 300px; height: 300px;"></canvas>
<object id="tuio" type="application/x-tuio">Plugin FAILED to load</object>

</body>
</html>